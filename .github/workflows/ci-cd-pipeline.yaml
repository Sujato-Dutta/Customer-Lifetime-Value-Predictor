name: CLV End-to-End CI/CD Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:       # Manual trigger

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
  MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
  MLFLOW_S3_ENDPOINT_URL: ${{ secrets.MLFLOW_S3_ENDPOINT_URL }}
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
  RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}
  RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}

jobs:
  clv-pipeline:
    runs-on: ubuntu-latest

    steps:
    - name: 🔄 Checkout Repository
      uses: actions/checkout@v3

    - name: 🐍 Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: 3.11.7

    - name: 📦 Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: 🧪 Run ETL + Ingestion + Feature Engineering
      run: |
        python run_pipeline.py
        python run_feature_engineering.py
        python run_preprocessor.py

    - name: 🤖 Train Model & Log to MLflow
      run: |
        python run_model_train.py

    - name: 📊 Run Final Predictions
      run: |
        python run_model_predict.py

  docker-and-deploy:
    needs: clv-pipeline
    runs-on: ubuntu-latest

    steps:
    - name: 🔄 Checkout Repository
      uses: actions/checkout@v3

    - name: 🔐 Docker Hub Login
      run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

    - name: 🐳 Build & Tag Streamlit Docker Image
      run: |
        docker build -f Dockerfile -t sujato/clv-streamlit:latest .

    - name: 🚀 Push to Docker Hub
      run: |
        docker push sujato/clv-streamlit:latest

    - name: ⚙️ Trigger Railway Deployment (Streamlit)
      run: |
        curl -X POST \
          -H "Authorization: Bearer ${{ secrets.RAILWAY_API_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d '{}' \
          "https://backboard.railway.app/project/${{ secrets.RAILWAY_PROJECT_ID }}/deployments"
